function FileRunChunk(e,t,i){this.frObj=e,this.fileObj=t,this.fileObjSize=t.size,this.offset=i,this.retries=0,this.pendingRetry=!1,this.loaded=0,this._lastLoaded=0,this.total=0,this.startByte=this.frObj.opts.chunkSize?t.offset+this.offset*this.frObj.opts.chunkSize:0,this.endByte=this.frObj.opts.chunkSize?Math.min(this.fileObjSize,this.startByte+this.frObj.opts.chunkSize):this.fileObjSize,this.size=this.endByte-this.startByte,this.xhr=null;var s=this;this.progressHandler=function(e){if(e.lengthComputable){if(s.loaded=Math.min(e.loaded,s.size),s.total=Math.min(e.total,s.size),s.loaded>s._lastLoaded){var t=s.loaded-s._lastLoaded;s.fileObj.completedBytes+=t,s.frObj.completedBytes+=t}s._lastLoaded=s.loaded}s.fileObj.chunkEvent("progress")},this.doneHandler=function(){var e=s.status(),t=s.message();if("success"===e)s.retries=0,s.fileObj.completedChunks++,s.fileObj.chunkEvent("success",t);else if(s.fileObj.uploadingChunk=!1,s.abort(),"error"===e)s.retries=0,s.fileObj.chunkEvent("error",t);else if(s.retries<s.frObj.opts.maxChunkRetries){s.retries++;var i=s.frObj.opts.chunkRetryInterval;null!==i?(s.retries>1&&(i*=s.retries),setTimeout(function(){s.send()},i)):s.send()}else s.retries=0,s.fileObj.chunkEvent("error",t)}}function FileRunFile(e,t){if(this.frObj=e,this.file=t,this.name=t.fileName||t.name,this.size=t.size,this.relativePath=t.relativePath||t.webkitRelativePath||!1,this.relativePath&&this.relativePath!=this.name){baseNameStartPos=this.relativePath.length-this.name.length;var i=this.relativePath.substring(baseNameStartPos);i==this.name&&(this.relativePath=this.relativePath.substring(0,baseNameStartPos))}this.uniqueIdentifier=e.generateUniqueIdentifier(t),this.offset=0,this.chunks=[],this.uploadingChunk=!1,this.completedChunks=0,this.completedBytes=0,this.lastCompletedBytes=0,this.complete=!1,this.uploading=!1,this.paused=!1,this.progress=0,this.queuePaused=!1,this.error=!1,this.averageSpeed=0,this.currentSpeed=0,this._lastProgressCallback=Date.now(),this._prevTransferredSize=0}function FileRun(e){this.files=[],this.paused=!1,this.averageSpeed=0,this.completedFiles=0,this.uploadingFiles=0,this.size=0,this.completedBytes=0,this.defaults={chunkSize:!1,singleFile:!1,fileParameterName:"file",progressCallbacksInterval:100,speedSmoothingFactor:.1,query:{},headers:{},withCredentials:!1,target:"/",generateUniqueIdentifier:null,maxChunkRetries:3,resumeLargerThan:10485760,chunkRetryInterval:null,maxSimultaneous:1},this.opts={},this.events={};var t=this;this.onDrop=function(e){e.stopPropagation(),e.preventDefault();var i=e.dataTransfer;i.items&&i.items[0]&&i.items[0].webkitGetAsEntry?t.webkitReadDataTransfer(e):t.addFiles(i.files,e)},this.opts=this.extend({},this.defaults,e||{})}FileRunChunk.prototype={getParams:function(){var e={frTotalSize:this.fileObjSize,frIsFirstChunk:0==this.startByte?1:0,frIsLastChunk:this.endByte==this.fileObjSize?1:0};return this.fileObj.relativePath&&(e.frRelativePath=this.fileObj.relativePath),navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&(e.frFilename=this.fileObj.name),e},getTarget:function(e){var t=this.frObj.opts.target;return t+=t.indexOf("?")<0?"?":"&",t+e.join("&")},send:function(){this.fileObj.uploadingChunk=this,this.loaded=0,this._lastLoaded=0,this.total=0,this.pendingRetry=!1;var e=this.fileObj.file.slice?"slice":this.fileObj.file.mozSlice?"mozSlice":this.fileObj.file.webkitSlice?"webkitSlice":"slice",t=this.fileObj.file[e](this.startByte,this.endByte);this.xhr=new XMLHttpRequest,this.xhr.upload.addEventListener("progress",this.progressHandler,!1),this.xhr.addEventListener("load",this.doneHandler,!1),this.xhr.addEventListener("error",this.doneHandler,!1);var i=this.prepareXhrRequest(t);this.xhr.send(i)},abort:function(){this.xhr&&(this.xhr.abort(),this.loaded&&(this.fileObj.completedBytes-=this.loaded,this.frObj.completedBytes-=this.loaded)),this.fileObj.chunkEvent("abort")},status:function(){return this.pendingRetry?"uploading":this.xhr?this.xhr.readyState<4?"uploading":this.frObj.opts.validateChunkResponse.call(this.frObj.opts.validateChunkResponseScope||this,this.xhr.status,this.xhr.responseText):"pending"},message:function(){return this.xhr?this.xhr.responseText:""},prepareXhrRequest:function(e){var t=this.frObj.opts.query;"function"==typeof t&&(t=t(this.fileObj,this)),t=this.frObj.extend(this.getParams(),t);var i=new FormData;return this.frObj.each(t,function(e,t){i.append(t,e)}),i.append(this.frObj.opts.fileParameterName,e,this.fileObj.name),this.xhr.open("POST",this.frObj.opts.target),this.xhr.withCredentials=this.frObj.opts.withCredentials,this.frObj.each(this.frObj.opts.headers,function(e,t){this.xhr.setRequestHeader(t,e)},this),i}},FileRunFile.prototype={measureSpeed:function(){var e=Date.now()-this._lastProgressCallback;if(e){var t=this.frObj.opts.speedSmoothingFactor;this.currentSpeed=Math.max((this.completedBytes-this._prevTransferredSize)/e*1e3,0),this.averageSpeed=t*this.currentSpeed+(1-t)*this.averageSpeed,this.frObj.averageSpeed=this.averageSpeed,this._prevTransferredSize=this.completedBytes}},chunkEvent:function(e,t){switch(e){case"progress":if(Date.now()-this._lastProgressCallback<this.frObj.opts.progressCallbacksInterval)break;this.reportProgress();break;case"error":this.error=!0,this.paused=!0,this.frObj.paused=!0,this.frObj.completedBytes-=this.completedBytes,this.completedBytes=0,this.reset(),this.frObj.onFileError(this,t);break;case"success":this.error=!1,this.paused=!1,this.removeUploadingChunk(this.uploadingChunk),this.completedChunks==this.chunks.length?(this.reportProgress(),this.uploading=!1,this.complete=!0,this.currentSpeed=0,this.averageSpeed=0,this.frObj.onFileSuccess(this,t),this.file=null):this.uploadNextChunk();break;case"retry":this.frObj.fire("fileRetry",this)}},reportProgress:function(){this.measureProgress(),this.measureSpeed(),this.frObj.fire("fileProgress",this),this.frObj.fire("progress",this.frObj),this._lastProgressCallback=Date.now()},uploadNextChunk:function(){this.paused||this.frObj.each(this.chunks,function(e){return e&&"pending"===e.status()?(e.send(),!1):void 0})},getOffsetHandler:function(){this.offset=0;var e=this.xhr.status,t=this.xhr.responseText;this.xhr=null;var i=this.frObj.opts.validateGetOffsetResponse.call(this.frObj.opts.validateGetOffsetResponseScope||this,this,e,t);i?(this.lastCompletedBytes=this.completedBytes,this.completedBytes=this.offset,this.lastCompletedBytes>0&&(this.frObj.completedBytes-=this.lastCompletedBytes),this.frObj.completedBytes+=this.offset,this.prepareChunks(),this.uploadNextChunk()):(this.error=!0,this.uploading=!1,this.frObj.onFileError(this,t))},getOffset:function(){this.xhr=new XMLHttpRequest,this.xhr.addEventListener("load",this.getOffsetHandler.bind(this),!1),this.xhr.addEventListener("error",this.getOffsetHandler.bind(this),!1);var e=this.frObj.opts.query;"function"==typeof e&&(e=e(this));var t={frGetOffset:1,frTotalSize:this.size,frFilename:this.name};this.relativePath&&(t.frRelativePath=this.relativePath),e=this.frObj.extend(t,e);var i=this.frObj.opts.target,s=new FormData;this.frObj.each(e,function(e,t){s.append(t,e)}),this.xhr.open("POST",i),this.xhr.withCredentials=this.frObj.opts.withCredentials,this.frObj.each(this.frObj.opts.headers,function(e,t){this.xhr.setRequestHeader(t,e)},this),this.xhr.send(s)},reset:function(){this.paused=!1,this.queuePaused=!1,this.uploading=!1,this.currentSpeed=0,this.averageSpeed=0,this.offset=0,this.uploadingChunk=!1,this.completedChunks=0,this.chunks=[]},pause:function(e){if(this.complete)return!1;var t;this.uploading&&(this.uploadingChunk&&this.uploadingChunk.abort(),t=!0),this.reset(),e&&(this.queuePaused=!0),this.paused=!0,this.frObj.onFilePause(this,e,t)},start:function(){return this.complete?!1:(this.reset(),this.uploading=!0,this.frObj.onFileStart(),void(!this.frObj.opts.chunkSize||this.size<this.frObj.opts.chunkSize&&this.size<this.frObj.opts.resumeLargerThan?(this.prepareChunks(),this.uploadNextChunk()):this.getOffset()))},prepareChunks:function(){if(this.frObj.opts.chunkSize>0)var e=Math.max(Math.ceil((this.file.size-this.offset)/this.frObj.opts.chunkSize),1);else var e=1;for(var t=0;e>t;t++)this.chunks.push(new FileRunChunk(this.frObj,this,t))},removeUploadingChunk:function(){for(var e=this.chunks.length,t=0;e>t;t++)if(this.chunks[t]==this.uploadingChunk)return this.uploadingChunk=null,this.chunks[t]=null,!0;return!1},measureProgress:function(){this.progress=this.error?0:this.complete?1:0==this.size&&0==this.completedBytes?1:this.completedBytes/this.size},timeRemaining:function(){if(this.paused||this.error||this.complete)return 0;var e=this.size-this.completedBytes;return e&&!this.averageSpeed?Number.POSITIVE_INFINITY:e||this.averageSpeed?Math.floor(e/this.averageSpeed):0}},FileRun.prototype={on:function(e,t){e=e.toLowerCase(),this.events.hasOwnProperty(e)||(this.events[e]=[]),this.events[e].push(t)},off:function(e,t){void 0!==e?(e=e.toLowerCase(),void 0!==t?this.events.hasOwnProperty(e)&&arrayRemove(this.events[e],t):delete this.events[e]):this.events={}},fire:function(e,t){t=Array.prototype.slice.call(arguments),e=e.toLowerCase();var i=!1;return this.events.hasOwnProperty(e)&&this.each(this.events[e],function(e){i=e.apply(this,t.slice(1))===!1||i}),"catchall"!=e&&(t.unshift("catchAll"),i=this.fire.apply(this,t)===!1||i),!i},webkitReadDataTransfer:function(e){function t(e){h+=e.length,n.each(e,function(e){if(e.isFile){var r=e.fullPath;e.file(function(e){i(e,r)},s)}else e.isDirectory&&e.createReader().readEntries(t,s)}),r()}function i(e,t){e.relativePath=t,a.push(e),r()}function s(e){throw e}function r(){0==--h&&n.addFiles(a,e)}var n=this,h=e.dataTransfer.items.length,a=[];this.each(e.dataTransfer.items,function(e){var n=e.webkitGetAsEntry();return n?void(n.isFile?i(e.getAsFile(),n.fullPath):n.createReader().readEntries(t,s)):void r()})},generateUniqueIdentifier:function(e){var t=this.opts.generateUniqueIdentifier;if("function"==typeof t)return t(e);var i=e.relativePath||e.webkitRelativePath||e.fileName||e.name;return e.size+"-"+i.replace(/[^0-9a-zA-Z_-]/gim,"")},browseFiles:function(e,t){FileRunUtils.browseFiles({entireFolder:e,singleFile:t,onSelect:function(e,t){e.length>0&&this.addFiles(e,t)},scope:this})},start:function(){this.paused=!1,this.uploadNextFile(),this.fire("uploadStart")},uploadNextFile:function(){if(this.paused)return!1;var e=0,t=0,i=!0;this.each(this.files,function(s){if(!s.complete)if(s.queuePaused)e++;else if(s.uploading)t++;else{if(!(this.uploadingFiles<this.opts.maxSimultaneous))return!1;i=!1,s.start()}},this),!i||e||t||this.fire("complete")},pause:function(){this.paused=!0,this.each(this.files,function(e){e.queuePaused||e.paused||e.complete||e.pause()}),this.uploadingFiles=0},removeAll:function(){for(var e=this.files.length-1;e>=0;e--)this.removeFile(this.files[e]);this.averageSpeed=0,this.uploadingFiles=0},getProgress:function(){return 0==this.size&&0==this.completedBytes?1:this.completedBytes/this.size},onFileSuccess:function(e,t){this.uploadingFiles--,this.completedFiles++,this.fire("progress",this),this.fire("fileSuccess",e,t),this.uploadNextFile()},onFileError:function(e,t){this.uploadingFiles--,this.fire("fileError",e,t),this.fire("error",t,e)},onFilePause:function(e,t,i){i&&this.uploadingFiles--,t&&this.uploadNextFile(),this.fire("fileProgress",e)},onFileStart:function(){this.uploadingFiles++},addFile:function(e,t){this.addFiles([e],t)},addFiles:function(e,t){this.each(e,function(e){if(this.opts.singleFile&&this.files.length>0)return!1;if((e.size%4096!==0||"."!==e.name&&"."!==e.fileName)&&!this.getFromUniqueIdentifier(this.generateUniqueIdentifier(e))){var i=new FileRunFile(this,e);this.fire("fileAdded",i,t)&&(this.files.push(i),this.size+=i.size)}},this),this.fire("filesSubmitted",this.files,t),this.opts.startOnSubmit&&this.start()},removeFile:function(e){for(var t=!1,i=this.files.length-1;i>=0;i--)this.files[i]===e&&(this.size-=e.size,e.uploading&&(e.uploadingChunk&&e.uploadingChunk.abort(),t=!0,this.uploadingFiles--),e.complete&&this.completedFiles--,this.completedBytes-=e.completedBytes,e=null,this.files.splice(i,1));return t&&this.uploadNextFile(),!0},getFromUniqueIdentifier:function(e){var t=!1;return this.each(this.files,function(i){i.uniqueIdentifier===e&&(t=i)}),t},timeRemaining:function(){var e=this.size-this.completedBytes;return e&&!this.averageSpeed?Number.POSITIVE_INFINITY:e||this.averageSpeed?Math.floor(e/this.averageSpeed):0},arrayRemove:function(e,t){var i=e.indexOf(t);i>-1&&e.splice(i,1)},extend:function(e){return this.each(arguments,function(t){t!==e&&this.each(t,function(t,i){e[i]=t})},this),e},each:function(e,t,i){if(e)if("undefined"!=typeof e.length){for(var s=0;s<e.length;s++)if(t.call(i,e[s],s)===!1)return}else for(var s in e)if(e.hasOwnProperty(s)&&t.call(i,e[s],s)===!1)return}};var FileRunUtils={browserSupport:{files:!("undefined"==typeof window.File||"undefined"==typeof Blob||"undefined"==typeof window.FileList||!Blob.prototype.slice&&!Blob.prototype.webkitSlice&&!Blob.prototype.mozSlice),folders:/WebKit/.test(window.navigator.userAgent)},attachDrop:function(e){return this.browserSupport.files?(e.domNode.addEventListener("dragenter",function(t){t.stopPropagation(),t.preventDefault(),e.onDragEnter&&e.onDragEnter.call(e.scope,t)},!1),e.domNode.addEventListener("dragover",function(t){return t.dataTransfer.dropEffect="copy",t.stopPropagation(),t.preventDefault(),e.onDragOver&&e.onDragOver.call(e.scope,t),!1},!1),e.domNode.addEventListener("dragleave",function(t){t.stopPropagation(),t.preventDefault(),e.onDragLeave&&e.onDragLeave.call(e.scope,t)},!1),void e.domNode.addEventListener("drop",function(t){t.stopPropagation(),t.preventDefault(),e.onDrop.call(e.scope,t)},!1)):!1},browseFiles:function(e){var t=document.createElement("input");t.setAttribute("type","file"),e.singleFile||(t.setAttribute("multiple","multiple"),e.entireFolder&&t.setAttribute("webkitdirectory","webkitdirectory")),t.style.display="none",t.addEventListener("change",function(t){e.onSelect.call(e.scope,t.target.files,t),document.body.removeChild(this)},!1),document.body.appendChild(t),t.click()}};